<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\ExpectedObjects\ExpectedObjects\src\ExpectedObjects\Strategies\ValueComparisonStrategy.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Reflection;

namespace ExpectedObjects.Strategies
{
    /// &lt;summary&gt;
    /// Compares configured members by value
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This strategy applies to comparisons where the expected or actual types contain members.
    /// &lt;/remarks&gt;
    public class ValueComparisonStrategy : IComparisonStrategy
    {
        public bool CanCompare(object expected, object actual)
        {
            var expectedHasMembers = expected.GetType().GetFields(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance).Length != 0 ||
                                     expected.GetType().GetProperties(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance).Length != 0;

            var actualHasMembers = expected.GetType().GetFields(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance).Length != 0 ||
                                   expected.GetType().GetProperties(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance).Length != 0;

            var expectedTypeInfo = expected.GetType().GetTypeInfo();
            var actualTypeInfo = actual.GetType().GetTypeInfo();
            
            return (expectedHasMembers || actualHasMembers) &amp;&amp;
                expectedTypeInfo.IsClass &amp;&amp; !expectedTypeInfo.IsArray &amp;&amp;
                actualTypeInfo.IsClass &amp;&amp; !actualTypeInfo.IsArray;
        }

        public bool AreEqual(object expected, object actual, IComparisonContext comparisonContext)
        {
            const bool equal = true;
            var areEqual = comparisonContext.CompareProperties(expected, actual,
                (pi, actualPropertyInfo) =&gt;
                    CompareProperty(pi, actualPropertyInfo, expected, actual,
                        comparisonContext, equal));

            areEqual = comparisonContext.CompareFields(expected, actual,
                           (fi, actualFieldInfo) =&gt;
                               CompareField(fi, actualFieldInfo, expected, actual, comparisonContext)) &amp;&amp; areEqual;

            return areEqual;
        }

        static bool CompareField(FieldInfo expectedFieldInfo, FieldInfo actualFieldInfo, object expected, object actual, IComparisonContext comparisonContext)
        {
            var value1 = expectedFieldInfo.GetValue(expected);

            if (actualFieldInfo == null)
                return comparisonContext
                    .ReportEquality(value1, Activator.CreateInstance(typeof(MissingMember&lt;&gt;)
                        .MakeGenericType(expectedFieldInfo.FieldType)), expectedFieldInfo.Name);

            var value2 = actualFieldInfo.GetValue(actual);
            return comparisonContext.ReportEquality(value1, value2, expectedFieldInfo.Name);
        }

        static bool CompareProperty(PropertyInfo expectedPropertyInfo, PropertyInfo actualPropertyInfo, object expected, object actual,
            IComparisonContext comparisonContext, bool areEqual)
        {
            var indexes = expectedPropertyInfo.GetIndexParameters();

            if (indexes.Length == 0)
                areEqual = CompareStandardProperty(expectedPropertyInfo, actualPropertyInfo, expected, actual, comparisonContext) &amp;&amp;
                           areEqual;
            else
                areEqual = CompareIndexedProperty(expectedPropertyInfo, expected, actual, indexes, comparisonContext) &amp;&amp; areEqual;

            return areEqual;
        }

        static bool CompareIndexedProperty(PropertyInfo pi, object expected, object actual, ParameterInfo[] indexes, IComparisonContext comparisonContext)
        {
            var areEqual = true;

            foreach (var index in indexes)
                if (index.ParameterType == typeof(int))
                {
                    var expectedCountPropertyInfo = expected.GetType().GetProperty(&quot;Count&quot;);

                    var actualCountPropertyInfo = actual.GetType().GetProperty(&quot;Count&quot;);

                    if (expectedCountPropertyInfo != null)
                    {
                        var expectedCount = (int) expectedCountPropertyInfo.GetValue(expected, null);
                        var actualCount = (int) actualCountPropertyInfo.GetValue(actual, null);

                        if (expectedCount != actualCount)
                        {
                            areEqual = false;
                            break;
                        }

                        for (var i = 0; i &lt; expectedCount; i++)
                        {
                            object[] indexValues = {i};
                            var value1 = pi.GetValue(expected, indexValues);
                            var value2 = pi.GetValue(actual, indexValues);

                            if (!comparisonContext.ReportEquality(value1, value2, pi.Name + &quot;[&quot; + i + &quot;]&quot;))
                                areEqual = false;
                        }
                    }
                }

            return areEqual;
        }

        static bool CompareStandardProperty(PropertyInfo pi1, PropertyInfo pi2, object expected, object actual,
            IComparisonContext comparisonContext)
        {
            var value1 = pi1.GetValue(expected, null);

            if (pi2 == null)
                return comparisonContext
                    .ReportEquality(value1, Activator.CreateInstance(typeof(MissingMember&lt;&gt;)
                        .MakeGenericType(pi1.PropertyType)), pi1.Name);

            var value2 = pi2.GetValue(actual, null);
            return comparisonContext.ReportEquality(value1, value2, pi1.Name);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,13,17,153,1],[19,13,20,151,1],[22,13,22,69,1],[23,13,23,65,1],[25,13,27,67,1],[33,13,35,21,1],[35,21,36,50,1],[36,50,36,52,1],[38,13,40,32,1],[40,32,40,102,0],[40,102,40,116,1],[42,13,42,29,1],[47,13,47,63,0],[49,13,49,41,0],[50,17,52,97,0],[54,13,54,59,0],[55,13,55,93,0],[61,13,61,69,1],[63,13,63,37,1],[64,17,65,37,1],[67,17,67,131,0],[69,13,69,29,1],[74,13,74,33,0],[76,22,76,31,0],[76,32,76,34,0],[76,35,76,42,0],[77,17,77,56,0],[79,21,79,93,0],[81,21,81,89,0],[83,21,83,59,0],[85,25,85,102,0],[86,25,86,96,0],[88,25,88,58,0],[90,29,90,46,0],[91,29,91,35,0],[94,30,94,39,0],[94,41,94,58,0],[94,60,94,63,0],[96,29,96,56,0],[97,29,97,77,0],[98,29,98,75,0],[100,29,100,108,0],[101,33,101,50,0],[106,13,106,29,0],[112,13,112,55,1],[114,13,114,29,1],[115,17,117,72,0],[119,13,119,53,1],[120,13,120,79,1]]);
    </script>
  </body>
</html>