<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\ExpectedObjects\ExpectedObjects\src\ExpectedObjects\ExpressionMemberContext.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;

namespace ExpectedObjects
{
    class ExpressionMemberContext&lt;TExpected, TMember&gt; : IMemberContext
    {
        readonly IMemberConfigurationContext _memberConfigurationContext;
        readonly Type _rootType;
        readonly Expression&lt;Func&lt;TExpected, TMember&gt;&gt; _memberExpression;

        public ExpressionMemberContext(IMemberConfigurationContext memberConfigurationContext, Type rootType, Expression&lt;Func&lt;TExpected, TMember&gt;&gt; memberExpression)
        {
            _memberConfigurationContext = memberConfigurationContext;
            _rootType = rootType;
            _memberExpression = memberExpression;
        }

        public void UsesComparison(IComparison comparison)
        {
            var memberPath = GetMemberPath(_memberExpression);
            memberPath = String.Join(&quot;.&quot;, new [] {_rootType.Name, memberPath}.Where(x =&gt; !string.IsNullOrEmpty(x)));
            _memberConfigurationContext.ConfigureMember(new AbsolutePathMemberComparison(comparison, _rootType, memberPath));
        }

        string GetMemberPath(Expression&lt;Func&lt;TExpected, TMember&gt;&gt; expr)
        {
            var members = new Stack&lt;string&gt;();
            MemberExpression memberExpression;

            switch (expr.Body.NodeType)
            {
                case ExpressionType.Convert:
                case ExpressionType.ConvertChecked:
                    var ue = expr.Body as UnaryExpression;
                    memberExpression = ue?.Operand as MemberExpression;
                    break;
                default:
                    memberExpression = expr.Body as MemberExpression;
                    break;
            }

            while (memberExpression != null)
            {
                if (memberExpression.Expression.NodeType == ExpressionType.Call)
                {
                    var propertyName = memberExpression.Member.Name;

                    var methodCallExpression = memberExpression.Expression as MethodCallExpression;
                    if (methodCallExpression.Method.Name == &quot;get_Item&quot;)
                    {
                        members.Push($&quot;{((MemberExpression)methodCallExpression.Object).Member.Name}[{methodCallExpression.Arguments[0]}].{propertyName}&quot;);
                    }

                    memberExpression = memberExpression.Expression as MemberExpression; 
                }
                else
                {
                    var propertyName = memberExpression.Member.Name;
                    members.Push(propertyName);
                    memberExpression = memberExpression.Expression as MemberExpression;    
                }
            }

            return string.Join(&quot;.&quot;, members.ToArray());
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,165,0],[16,13,16,70,0],[17,13,17,34,0],[18,13,18,50,0],[19,9,19,10,0],[23,13,23,63,0],[24,13,24,90,0],[24,90,24,114,0],[24,114,24,117,0],[25,13,25,126,0],[26,9,26,10,0],[30,13,30,47,0],[33,13,33,40,0],[37,21,37,59,0],[38,21,38,72,0],[39,21,39,27,0],[41,21,41,70,0],[42,21,42,27,0],[45,13,45,45,0],[47,17,47,81,0],[49,21,49,69,0],[51,21,51,100,0],[52,21,52,72,0],[54,25,54,156,0],[57,21,57,88,0],[61,21,61,69,0],[62,21,62,48,0],[63,21,63,88,0],[67,13,67,56,0]]);
    </script>
  </body>
</html>