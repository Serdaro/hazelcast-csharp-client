<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\Hazelcast.Net\Serialization\DefaultPortableWriter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) 2008-2021, Hazelcast, Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

using System.Collections.Generic;
using Hazelcast.Core;

namespace Hazelcast.Serialization
{
    internal class DefaultPortableWriter : IPortableWriter
    {
        private readonly int _begin;
        private readonly IClassDefinition _cd;
        private readonly int _offset;
        private readonly ObjectDataOutput _out;
        private readonly PortableSerializer _serializer;
        private readonly ISet&lt;string&gt; _writtenFields;
        private bool _raw;

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public DefaultPortableWriter(PortableSerializer serializer, ObjectDataOutput @out, IClassDefinition cd)
        {
            _serializer = serializer;
            _out = @out;
            _cd = cd;
            _writtenFields = new HashSet&lt;string&gt;(); //cd.GetFieldCount()
            _begin = @out.Position;
            // room for final offset
            @out.WriteZeroBytes(4);
            @out.WriteInt(cd.GetFieldCount());
            _offset = @out.Position;
            // one additional for raw data
            var fieldIndexesLength = (cd.GetFieldCount() + 1)* BytesExtensions.SizeOfInt;
            @out.WriteZeroBytes(fieldIndexesLength);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteInt(string fieldName, int value)
        {
            SetPosition(fieldName, FieldType.Int);
            _out.WriteInt(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteLong(string fieldName, long value)
        {
            SetPosition(fieldName, FieldType.Long);
            _out.WriteLong(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteString(string fieldName, string str)
        {
            SetPosition(fieldName, FieldType.Utf);
            _out.WriteString(str);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteBoolean(string fieldName, bool value)
        {
            SetPosition(fieldName, FieldType.Boolean);
            _out.WriteBoolean(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteByte(string fieldName, byte value)
        {
            SetPosition(fieldName, FieldType.Byte);
            _out.WriteByte(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteChar(string fieldName, char value)
        {
            SetPosition(fieldName, FieldType.Char);
            _out.WriteChar(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteDouble(string fieldName, double value)
        {
            SetPosition(fieldName, FieldType.Double);
            _out.WriteDouble(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteFloat(string fieldName, float value)
        {
            SetPosition(fieldName, FieldType.Float);
            _out.WriteFloat(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteShort(string fieldName, short value)
        {
            SetPosition(fieldName, FieldType.Short);
            _out.WriteShort(value);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WritePortable(string fieldName, IPortable portable)
        {
            var fd = SetPosition(fieldName, FieldType.Portable);
            var isNull = portable == null;
            _out.WriteBoolean(isNull);
            _out.WriteInt(fd.FactoryId);
            _out.WriteInt(fd.ClassId);
            if (!isNull)
            {
                CheckPortableAttributes(fd, portable);
                _serializer.WriteInternal(_out, portable);
            }
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteNullPortable(string fieldName, int factoryId, int classId)
        {
            SetPosition(fieldName, FieldType.Portable);
            _out.WriteBoolean(true);
            _out.WriteInt(factoryId);
            _out.WriteInt(classId);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteBooleanArray(string fieldName, bool[] values)
        {
            SetPosition(fieldName, FieldType.BooleanArray);
            _out.WriteBooleanArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteByteArray(string fieldName, byte[] values)
        {
            SetPosition(fieldName, FieldType.ByteArray);
            _out.WriteByteArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteCharArray(string fieldName, char[] values)
        {
            SetPosition(fieldName, FieldType.CharArray);
            _out.WriteCharArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteIntArray(string fieldName, int[] values)
        {
            SetPosition(fieldName, FieldType.IntArray);
            _out.WriteIntArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteLongArray(string fieldName, long[] values)
        {
            SetPosition(fieldName, FieldType.LongArray);
            _out.WriteLongArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteDoubleArray(string fieldName, double[] values)
        {
            SetPosition(fieldName, FieldType.DoubleArray);
            _out.WriteDoubleArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteFloatArray(string fieldName, float[] values)
        {
            SetPosition(fieldName, FieldType.FloatArray);
            _out.WriteFloatArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteShortArray(string fieldName, short[] values)
        {
            SetPosition(fieldName, FieldType.ShortArray);
            _out.WriteShortArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WriteStringArray(string fieldName, string[] values)
        {
            SetPosition(fieldName, FieldType.UtfArray);
            _out.WriteStringArray(values);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual void WritePortableArray&lt;TPortable&gt;(string fieldName, TPortable[] portables) where TPortable : IPortable
        {
            var fd = SetPosition(fieldName, FieldType.PortableArray);
            var len = portables?.Length ?? BytesExtensions.SizeOfNullArray;
            _out.WriteInt(len);
            _out.WriteInt(fd.FactoryId);
            _out.WriteInt(fd.ClassId);
            if (len &gt; 0)
            {
                var offset = _out.Position;
                _out.WriteZeroBytes(len*4);
                for (var i = 0; i &lt; portables.Length; i++)
                {
                    var portable = portables[i];
                    CheckPortableAttributes(fd, portable);
                    var position = _out.Position;
                    _out.WriteInt(offset + i* BytesExtensions.SizeOfInt, position);
                    _serializer.WriteInternal(_out, portable);
                }
            }
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        public virtual IObjectDataOutput GetRawDataOutput()
        {
            if (!_raw)
            {
                var pos = _out.Position;
                // last index
                var index = _cd.GetFieldCount();
                _out.WriteInt(_offset + index* BytesExtensions.SizeOfInt, pos);
            }
            _raw = true;
            return _out;
        }

        public virtual int GetVersion()
        {
            return _cd.Version;
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        internal virtual void End()
        {
            // write final offset
            var position = _out.Position;
            _out.WriteInt(_begin, position);
        }

        private static void CheckPortableAttributes(IFieldDefinition fd, IPortable portable)
        {
            if (fd.FactoryId != portable.FactoryId)
            {
                throw new SerializationException(
                    &quot;Wrong Portable type! Generic portable types are not supported! &quot; + &quot; Expected factory-id: &quot; +
                    fd.FactoryId + &quot;, Actual factory-id: &quot; + portable.FactoryId);
            }
            if (fd.ClassId != portable.ClassId)
            {
                throw new SerializationException(
                    &quot;Wrong Portable type! Generic portable types are not supported! &quot; + &quot;Expected class-id: &quot; +
                    fd.ClassId + &quot;, Actual class-id: &quot; + portable.ClassId);
            }
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot; /&gt;
        private IFieldDefinition SetPosition(string fieldName, FieldType fieldType)
        {
            if (_raw)
            {
                throw new SerializationException(
                    &quot;Cannot write Portable fields after getRawDataOutput() is called!&quot;);
            }
            var fd = _cd.GetField(fieldName);
            if (fd == null)
            {
                throw new SerializationException(&quot;Invalid field name: &#39;&quot; + fieldName +
                                                          &quot;&#39; for ClassDefinition {id: &quot; + _cd.ClassId +
                                                          &quot;, version: &quot; + _cd.Version + &quot;}&quot;);
            }
            if (_writtenFields.Add(fieldName))
            {
                var pos = _out.Position;
                var index = fd.Index;
                _out.WriteInt(_offset + index* BytesExtensions.SizeOfInt, pos);
                _out.WriteShort((short)fieldName.Length);
                _out.WriteBytes(fieldName);
                _out.WriteByte((byte) fieldType);
            }
            else
            {
                throw new SerializationException(&quot;Field &#39;&quot; + fieldName + &quot;&#39; has already been written!&quot;);
            }
            return fd;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,112,1],[33,13,33,38,1],[34,13,34,25,1],[35,13,35,22,1],[36,13,36,52,1],[37,13,37,36,1],[39,13,39,36,1],[40,13,40,47,1],[41,13,41,37,1],[43,13,43,90,1],[44,13,44,53,1],[45,9,45,10,1],[50,13,50,51,1],[51,13,51,34,1],[52,9,52,10,1],[57,13,57,52,1],[58,13,58,35,1],[59,9,59,10,1],[64,13,64,51,1],[65,13,65,35,1],[66,9,66,10,1],[71,13,71,55,1],[72,13,72,38,1],[73,9,73,10,1],[78,13,78,52,1],[79,13,79,35,1],[80,9,80,10,1],[85,13,85,52,1],[86,13,86,35,1],[87,9,87,10,1],[92,13,92,54,1],[93,13,93,37,1],[94,9,94,10,1],[99,13,99,53,1],[100,13,100,36,1],[101,9,101,10,1],[106,13,106,53,1],[107,13,107,36,1],[108,9,108,10,1],[113,13,113,65,1],[114,13,114,43,1],[115,13,115,39,1],[116,13,116,41,1],[117,13,117,39,1],[118,13,118,25,1],[120,17,120,55,1],[121,17,121,59,1],[123,9,123,10,1],[128,13,128,56,1],[129,13,129,37,1],[130,13,130,38,1],[131,13,131,36,1],[132,9,132,10,1],[137,13,137,60,1],[138,13,138,44,1],[139,9,139,10,1],[144,13,144,57,1],[145,13,145,41,1],[146,9,146,10,1],[151,13,151,57,1],[152,13,152,41,1],[153,9,153,10,1],[158,13,158,56,1],[159,13,159,40,1],[160,9,160,10,1],[165,13,165,57,1],[166,13,166,41,1],[167,9,167,10,1],[172,13,172,59,1],[173,13,173,43,1],[174,9,174,10,1],[179,13,179,58,1],[180,13,180,42,1],[181,9,181,10,1],[186,13,186,58,1],[187,13,187,42,1],[188,9,188,10,1],[193,13,193,56,1],[194,13,194,43,1],[195,9,195,10,1],[200,13,200,70,1],[201,13,201,76,1],[202,13,202,32,1],[203,13,203,41,1],[204,13,204,39,1],[205,13,205,25,1],[207,17,207,44,1],[208,17,208,44,1],[209,22,209,31,1],[209,33,209,53,1],[209,55,209,58,1],[211,21,211,49,1],[212,21,212,59,1],[213,21,213,50,1],[214,21,214,84,1],[215,21,215,63,1],[218,9,218,10,1],[223,13,223,23,1],[225,17,225,41,1],[227,17,227,49,1],[228,17,228,80,1],[230,13,230,25,1],[231,13,231,25,1],[236,13,236,32,0],[243,13,243,42,1],[244,13,244,45,1],[245,9,245,10,1],[249,13,249,52,1],[251,17,253,82,0],[255,13,255,48,1],[257,17,259,76,0],[261,9,261,10,1],[266,13,266,22,1],[268,17,269,89,1],[271,13,271,46,1],[272,13,272,28,1],[274,17,276,94,0],[278,13,278,47,1],[280,17,280,41,1],[281,17,281,38,1],[282,17,282,80,1],[283,17,283,58,1],[284,17,284,44,1],[285,17,285,50,1],[289,17,289,105,0],[291,13,291,23,1]]);
    </script>
  </body>
</html>