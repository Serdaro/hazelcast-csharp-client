<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\ExpectedObjects\ExpectedObjects\src\ExpectedObjects\EqualityComparer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using ExpectedObjects.Chain;
using ExpectedObjects.Chain.Links;
using ExpectedObjects.Reporting;

namespace ExpectedObjects
{
    public class EqualityComparer : IComparisonContext
    {
        readonly IConfiguration _configurationContext;
        readonly Stack&lt;string&gt; _elementStack = new Stack&lt;string&gt;();
        readonly StackDictionary&lt;object, IComparisonResult&gt; _visited = new StackDictionary&lt;object, IComparisonResult&gt;();
        bool _ignoreTypeInformation;
        IWriter _writer;
        object _expected;
        StrategyChain _strategyChain;

        public EqualityComparer(IConfiguration configurationContext)
        {
            _configurationContext = configurationContext;
            InitializeStrategyChain();
        }

        void InitializeStrategyChain()
        {
            _strategyChain = new StrategyChain();
            _strategyChain.Link(new TypeStrategyComparisonLink());
            _strategyChain.Link(new MemberComparisonLink());
            _strategyChain.Link(new ReferenceEqualsComparisonLink());
            _strategyChain.Link(new NullExpectedComparisonLink());
            _strategyChain.Link(new ComparisonComparisonLink());
            _strategyChain.Link(new MissingComparisonLink());
            _strategyChain.Link(new InstanceOfTypeComparisonLink());
            _strategyChain.Link(new LeafInstanceOfTypeComparisonLink());
            _strategyChain.Link(new NullActualComparisonLink());
            _strategyChain.Link(new StrategyComparisonLink());
            _strategyChain.Link(new TrueLink());
        }

        public bool AreEqual(object expected, object actual, string member)
        {
            var existingWriter = _writer;
            try
            {
                _writer = new NullWriter();
                if (actual != null &amp;&amp; _visited.ContainsKey(actual))
                    return _visited[actual].Result;

                if (actual != null)
                    _visited.Push(actual, new ComparisonResult(actual, true));

                var result = Compare(expected, actual, member, _writer);

                if (actual != null)
                    _visited.Pop(actual);

                return result;
            }
            finally
            {
                _writer = existingWriter;
            }
        }

        public bool ReportEquality(object expected, object actual, string member)
        {
            if (actual != null &amp;&amp; _visited.ContainsKey(actual))
                return _visited[actual].Result;

            if (actual != null)
                _visited.Push(actual, new ComparisonResult(actual, true));

            var result = Compare(expected, actual, member, _writer);

            if (actual != null)
                _visited.Pop(actual);

            return result;
        }

        public bool CompareProperties(object expected, object actual, Func&lt;PropertyInfo, PropertyInfo, bool&gt; propertyComparison)
        {
            const BindingFlags flags = BindingFlags.Public | BindingFlags.Instance;
            var expectedPropertyInfos = expected.GetType().GetVisibleProperties(flags);
            var actualPropertyInfos = actual.GetType().GetVisibleProperties(flags);
            var areEqual = true;

            expectedPropertyInfos.ToList().ForEach(propertyInfo =&gt;
            {
                try
                {
                    areEqual = propertyComparison(propertyInfo,
                        actualPropertyInfos.SingleOrDefault(p =&gt; p.Name.Equals(propertyInfo.Name) &amp;&amp;
                                                                 p.HasSameIndexParameters(propertyInfo))) &amp;&amp; areEqual;
                }
                catch (Exception e)
                {
                    var res = actualPropertyInfos.Where(p =&gt; p.Name.Equals(propertyInfo.Name) &amp;&amp; p.HasSameIndexParameters(propertyInfo));
                    Console.WriteLine(e);
                    throw;
                }
            });

            return areEqual;
        }

        public bool CompareFields(object expected, object actual, Func&lt;FieldInfo, FieldInfo, bool&gt; comparison)
        {
            var flags = _configurationContext.GetFieldBindingFlags();
            var expectedFieldInfos = expected.GetType().GetFields(flags);
            var actualFieldInfos = actual.GetType().GetFields(flags);
            var areEqual = true;
            expectedFieldInfos.ToList().ForEach(fieldInfo =&gt;
            {
                areEqual = comparison(fieldInfo, actualFieldInfos.SingleOrDefault(f =&gt; f.Name.Equals(fieldInfo.Name))) &amp;&amp; areEqual;
            });

            return areEqual;
        }

        public void Report(bool status, string message, object expected, object actual)
        {
            _writer.Write(new EqualityResult(status, GetMemberPath(), expected, actual,
                EqualityResultType.Custom, message));
        }

        public bool AreEqual(object expected, object actual, IWriter writer, bool ignoreTypeInformation = false)
        {
            _expected = expected;
            _writer = writer;
            _ignoreTypeInformation = ignoreTypeInformation;
            return ReportEquality(expected, actual, actual?.GetType().ToUsefulTypeName() ?? string.Empty);
        }

        bool Compare(object expected, object actual, string member, IWriter writer)
        {
            try
            {
                _elementStack.Push(member);

                var linkContext = new LinkComparisonContext
                {
                    Expected = expected,
                    Actual =  actual,
                    ComparisonContext = this,
                    MemberPath = GetExpectedMemberPath(),
                    Configuration = _configurationContext,
                    IgnoreTypeInformation = _ignoreTypeInformation
                };

                var result = _strategyChain.Process(linkContext);

                if (_elementStack.Count &gt; 0)
                    writer.Write(new EqualityResult(result.Result, GetMemberPath(), result.ExpectedResult ?? expected, actual));
                return result.Result;
            }
            finally
            {
                if (_elementStack.Count &gt; 0)
                    _elementStack.Pop();
            }
        }

        string GetExpectedMemberPath()
        {
            var memberPath = GetMemberPath();
            if (_expected != null)
                memberPath = ReplaceRootName(memberPath, _expected.GetType().Name);

            return memberPath;
        }

        static string ReplaceRootName(string path, string rootName)
        {
            return string.Join(&quot;.&quot;, new [] { rootName, string.Join(&quot;.&quot;, path.Split(&#39;.&#39;).Skip(1))}.Where(x =&gt; !string.IsNullOrEmpty(x)));
        }

        string GetMemberPath()
        {
            var sb = new StringBuilder();

            sb.Append(string.Join(&quot;.&quot;, _elementStack.Reverse().ToArray()));
            sb.Replace(&quot;.[&quot;, &quot;[&quot;);
            return sb.ToString();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,68,1],[16,9,16,121,1],[22,9,22,69,1],[24,13,24,58,1],[25,13,25,39,1],[26,9,26,10,1],[30,13,30,50,1],[31,13,31,67,1],[32,13,32,61,1],[33,13,33,70,1],[34,13,34,67,1],[35,13,35,65,1],[36,13,36,62,1],[37,13,37,69,1],[38,13,38,73,1],[39,13,39,65,1],[40,13,40,63,1],[41,13,41,49,1],[42,9,42,10,1],[46,13,46,42,1],[49,17,49,44,1],[50,17,50,68,1],[51,21,51,52,0],[53,17,53,36,1],[54,21,54,79,1],[56,17,56,73,1],[58,17,58,36,1],[59,21,59,42,1],[61,17,61,31,1],[65,17,65,42,1],[66,13,66,14,1],[67,9,67,10,1],[71,13,71,64,1],[72,17,72,48,0],[74,13,74,32,1],[75,17,75,75,1],[77,13,77,69,1],[79,13,79,32,1],[80,17,80,38,1],[82,13,82,27,1],[88,13,88,88,1],[89,13,89,84,1],[90,13,90,33,1],[92,13,96,21,1],[96,21,97,66,1],[97,66,98,104,1],[98,104,98,119,1],[98,119,99,17,1],[99,17,99,18,1],[99,18,102,21,1],[102,21,102,62,0],[102,62,102,136,0],[102,136,102,138,0],[102,138,103,21,1],[103,21,103,42,0],[103,42,104,21,1],[104,21,104,27,0],[104,27,106,13,1],[106,13,106,14,1],[106,14,106,16,1],[108,13,108,29,1],[113,13,113,70,1],[114,13,114,74,1],[115,13,115,70,1],[116,13,116,33,1],[117,13,119,17,1],[119,17,119,88,0],[119,88,119,117,0],[119,117,119,132,0],[119,132,120,13,1],[120,13,120,14,0],[120,14,120,16,1],[122,13,122,29,1],[127,13,128,54,0],[129,9,129,10,0],[133,13,133,34,1],[134,13,134,30,1],[135,13,135,60,1],[136,13,136,107,1],[143,17,143,44,1],[145,17,153,19,1],[155,17,155,66,1],[157,17,157,45,1],[158,21,158,129,1],[159,17,159,38,1],[163,17,163,45,1],[164,21,164,41,1],[165,13,165,14,1],[166,9,166,10,1],[170,13,170,46,1],[171,13,171,35,1],[172,17,172,84,1],[174,13,174,31,1],[179,13,179,110,1],[179,110,179,134,1],[179,134,179,137,1],[184,13,184,42,1],[186,13,186,76,1],[187,13,187,35,1],[188,13,188,34,1]]);
    </script>
  </body>
</html>