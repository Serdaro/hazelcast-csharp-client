<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\Hazelcast.Net\NearCaching\NearCacheStatistics.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) 2008-2021, Hazelcast, Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

using System.Collections.Generic;
using System.Threading;
using Hazelcast.Core;
using Hazelcast.Metrics;

namespace Hazelcast.NearCaching
{
    internal class NearCacheStatistics : IMetricSource
    {
        private readonly MetricDescriptors _metricDescriptors;

        private long _evictions;
        private long _expirations;
        private long _hits;
        private long _misses;
        private long _staleReads;
        private long _ownedEntryCount;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;NearCacheStatistics&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The name of the cache.&lt;/param&gt;
        public NearCacheStatistics(string name)
        {
            CreationTime = Clock.Milliseconds;
            _metricDescriptors = new MetricDescriptors(name);
        }

        /// &lt;summary&gt;
        /// Gets the time when the cache was created.
        /// &lt;/summary&gt;
        public long CreationTime { get; }

        /// &lt;summary&gt;
        /// Gets the number of hits.
        /// &lt;/summary&gt;
        public long Hits =&gt; Interlocked.Read(ref _hits);

        /// &lt;summary&gt;
        /// Gets the number of misses.
        /// &lt;/summary&gt;
        public long Misses =&gt; Interlocked.Read(ref _misses);

        /// &lt;summary&gt;
        /// Gets the number of stale reads.
        /// &lt;/summary&gt;
        public long StaleReads =&gt; Interlocked.Read(ref _staleReads);

        /// &lt;summary&gt;
        /// Gets the number of evictions.
        /// &lt;/summary&gt;
        public long Evictions =&gt; Interlocked.Read(ref _evictions);

        /// &lt;summary&gt;
        /// Gets the number of expirations.
        /// &lt;/summary&gt;
        public long Expirations =&gt; Interlocked.Read(ref _expirations);

        /// &lt;summary&gt;
        /// Gets the number of entries.
        /// &lt;/summary&gt;
        public long EntryCount
        {
            get =&gt; Interlocked.Read(ref _ownedEntryCount);
            set =&gt; _ownedEntryCount = value;
        }

        /// &lt;summary&gt;
        /// Notifies of an added entry.
        /// &lt;/summary&gt;
        public void NotifyEntryRemoved()
        {
            Interlocked.Decrement(ref _ownedEntryCount);
        }

        /// &lt;summary&gt;
        /// Notifies of a removed entry.
        /// &lt;/summary&gt;
        public void NotifyEntryAdded()
        {
            Interlocked.Increment(ref _ownedEntryCount);
        }

        /// &lt;summary&gt;
        /// Resets the number of entries.
        /// &lt;/summary&gt;
        public void ResetEntryCount()
        {
            Interlocked.Exchange(ref _ownedEntryCount, 0);
        }

        /// &lt;summary&gt;
        /// Notifies of an eviction.
        /// &lt;/summary&gt;
        public void NotifyEviction()
        {
            Interlocked.Increment(ref _evictions);
        }

        /// &lt;summary&gt;
        /// Notifies of an expiration.
        /// &lt;/summary&gt;
        public void NotifyExpiration()
        {
            Interlocked.Increment(ref _expirations);
        }

        /// &lt;summary&gt;
        /// Notifies of a hit.
        /// &lt;/summary&gt;
        public void NotifyHit()
        {
            Interlocked.Increment(ref _hits);
        }

        /// &lt;summary&gt;
        /// Notifies of a miss.
        /// &lt;/summary&gt;
        public void NotifyMiss()
        {
            Interlocked.Increment(ref _misses);
        }

        /// &lt;summary&gt;
        /// Notifies of a stale entry.
        /// &lt;/summary&gt;
        public void NotifyStaleRead()
        {
            Interlocked.Increment(ref _staleReads);
        }


        private class MetricDescriptors
        {
            public MetricDescriptors(string name)
            {
                var prefix = &quot;nc&quot; + EnumerableOfMetricsExtensions.NameSeparator + name.TrimStart(&#39;/&#39;);

                CreationTime = new MetricDescriptor&lt;long&gt;(prefix, &quot;creationTime&quot;);
                Evictions = new MetricDescriptor&lt;long&gt;(prefix, &quot;evictions&quot;);
                Hits = new MetricDescriptor&lt;long&gt;(prefix, &quot;hits&quot;);
                Misses = new MetricDescriptor&lt;long&gt;(prefix, &quot;misses&quot;);
                EntryCount = new MetricDescriptor&lt;long&gt;(prefix, &quot;ownedEntryCount&quot;);
                Expirations = new MetricDescriptor&lt;long&gt;(prefix, &quot;expirations&quot;);
                Invalidations = new MetricDescriptor&lt;long&gt;(prefix, &quot;invalidations&quot;);
                InvalidationRequests = new MetricDescriptor&lt;long&gt;(prefix, &quot;invalidationRequests&quot;);
                OwnedEntryMemoryCost = new MetricDescriptor&lt;long&gt;(prefix, &quot;ownedEntryMemoryCost&quot;);

                LastPersistenceDuration = new MetricDescriptor&lt;long&gt;(prefix, &quot;lastPersistenceDuration&quot;);
                LastPersistenceKeyCount = new MetricDescriptor&lt;long&gt;(prefix, &quot;lastPersistenceKeyCount&quot;);
                LastPersistenceTime = new MetricDescriptor&lt;long&gt;(prefix, &quot;lastPersistenceTime&quot;);
                LastPersistenceWrittenBytes = new MetricDescriptor&lt;long&gt;(prefix, &quot;lastPersistenceWrittenBytes&quot;);
            }

            public readonly MetricDescriptor&lt;long&gt; CreationTime;
            public readonly MetricDescriptor&lt;long&gt; Evictions;
            public readonly MetricDescriptor&lt;long&gt; Hits;
            public readonly MetricDescriptor&lt;long&gt; Misses;
            public readonly MetricDescriptor&lt;long&gt; EntryCount;
            public readonly MetricDescriptor&lt;long&gt; Expirations;
            public readonly MetricDescriptor&lt;long&gt; Invalidations;
            public readonly MetricDescriptor&lt;long&gt; InvalidationRequests;
            public readonly MetricDescriptor&lt;long&gt; OwnedEntryMemoryCost;

            public readonly MetricDescriptor&lt;long&gt; LastPersistenceDuration;
            public readonly MetricDescriptor&lt;long&gt; LastPersistenceKeyCount;
            public readonly MetricDescriptor&lt;long&gt; LastPersistenceTime;
            public readonly MetricDescriptor&lt;long&gt; LastPersistenceWrittenBytes;
        }

        public IEnumerable&lt;Metric&gt; PublishMetrics()
        {
            // these are the stats currently sent by the Java v4 client

            yield return _metricDescriptors.CreationTime.WithValue(CreationTime);
            yield return _metricDescriptors.Evictions.WithValue(Evictions);
            yield return _metricDescriptors.Hits.WithValue(Hits);
            yield return _metricDescriptors.Misses.WithValue(Misses);
            yield return _metricDescriptors.EntryCount.WithValue(EntryCount);
            yield return _metricDescriptors.Expirations.WithValue(Expirations);

            yield return _metricDescriptors.Invalidations.WithoutValue();
            yield return _metricDescriptors.InvalidationRequests.WithoutValue();
            yield return _metricDescriptors.OwnedEntryMemoryCost.WithoutValue();

            yield return _metricDescriptors.LastPersistenceDuration.WithoutValue();
            yield return _metricDescriptors.LastPersistenceKeyCount.WithoutValue();
            yield return _metricDescriptors.LastPersistenceTime.WithoutValue();
            yield return _metricDescriptors.LastPersistenceWrittenBytes.WithoutValue();

            // TODO: &quot;lastPersistenceFailure&quot;) if ... ?
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,48,0],[39,13,39,47,0],[40,13,40,62,0],[41,9,41,10,0],[46,36,46,40,0],[51,29,51,56,0],[56,31,56,60,0],[61,35,61,68,0],[66,34,66,66,0],[71,36,71,70,0],[78,20,78,58,0],[79,20,79,44,0],[87,13,87,57,0],[88,9,88,10,0],[95,13,95,57,0],[96,9,96,10,0],[103,13,103,59,0],[104,9,104,10,0],[111,13,111,51,0],[112,9,112,10,0],[119,13,119,53,0],[120,9,120,10,0],[127,13,127,46,0],[128,9,128,10,0],[135,13,135,48,0],[136,9,136,10,0],[143,13,143,52,0],[144,9,144,10,0],[149,13,149,50,0],[151,17,151,103,0],[153,17,153,83,0],[154,17,154,77,0],[155,17,155,67,0],[156,17,156,71,0],[157,17,157,84,0],[158,17,158,81,0],[159,17,159,85,0],[160,17,160,99,0],[161,17,161,99,0],[163,17,163,105,0],[164,17,164,105,0],[165,17,165,97,0],[166,17,166,113,0],[167,13,167,14,0],[189,13,189,82,0],[190,13,190,76,0],[191,13,191,66,0],[192,13,192,70,0],[193,13,193,78,0],[194,13,194,80,0],[196,13,196,74,0],[197,13,197,81,0],[198,13,198,81,0],[200,13,200,84,0],[201,13,201,84,0],[202,13,202,80,0],[203,13,203,88,0],[206,9,206,10,0]]);
    </script>
  </body>
</html>