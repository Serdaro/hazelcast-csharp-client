<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\Hazelcast.Net\Serialization\PortableSerializer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) 2008-2021, Hazelcast, Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

using System;
using System.Collections.Generic;
using System.Linq;

namespace Hazelcast.Serialization
{
    internal sealed class PortableSerializer : IStreamSerializer&lt;IPortable&gt;
    {
        private readonly PortableContext _context;
        private readonly IDictionary&lt;int, IPortableFactory&gt; _factories = new Dictionary&lt;int, IPortableFactory&gt;();

        internal PortableSerializer(PortableContext context,
            IEnumerable&lt;KeyValuePair&lt;int, IPortableFactory&gt;&gt; portableFactories)
        {
            _context = context;
            _factories = _factories.Union(portableFactories).ToDictionary(x =&gt; x.Key, x =&gt; x.Value);
        }

        public int TypeId =&gt; SerializationConstants.ConstantTypePortable;

        /// &lt;exception cref=&quot;System.IO.IOException&quot;&gt;&lt;/exception&gt;
        public void Write(IObjectDataOutput output, IPortable p)
        {
            if (!(output is ObjectDataOutput))
            {
                throw new ArgumentException(&quot;ObjectDataOutput must be instance of BufferObjectDataOutput!&quot;);
            }
            if (p.ClassId == 0)
            {
                throw new ArgumentException(&quot;Portable class id cannot be zero!&quot;);
            }
            output.WriteInt(p.FactoryId);
            output.WriteInt(p.ClassId);
            WriteInternal((ObjectDataOutput) output, p);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot;&gt;&lt;/exception&gt;
        public IPortable Read(IObjectDataInput input)
        {
            if (!(input is ObjectDataInput))
            {
                throw new ArgumentException(&quot;ObjectDataInput must be instance of BufferObjectDataInput!&quot;);
            }
            var factoryId = input.ReadInt();
            var classId = input.ReadInt();
            return Read((ObjectDataInput) input, factoryId, classId);
        }

        public void Dispose()
        {
            _factories.Clear();
        }

        internal DefaultPortableReader CreateMorphingReader(ObjectDataInput input)
        {
            var factoryId = input.ReadInt();
            var classId = input.ReadInt();
            var version = input.ReadInt();

            var portable = CreateNewPortableInstance(factoryId, classId);
            var portableVersion = FindPortableVersion(factoryId, classId, portable);

            return CreateReader(input, factoryId, classId, version, portableVersion);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot;&gt;&lt;/exception&gt;
        internal DefaultPortableReader CreateReader(ObjectDataInput input)
        {
            var factoryId = input.ReadInt();
            var classId = input.ReadInt();
            var version = input.ReadInt();
            return CreateReader(input, factoryId, classId, version, version);
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot;/&gt;
        internal void WriteInternal(ObjectDataOutput output, IPortable p)
        {
            var cd = _context.LookupOrRegisterClassDefinition(p);
            output.WriteInt(cd.Version);
            var writer = new DefaultPortableWriter(this, output, cd);
            p.WritePortable(writer);
            writer.End();
        }

        private IPortable CreateNewPortableInstance(int factoryId, int classId)
        {
            _factories.TryGetValue(factoryId, out var portableFactory);
            if (portableFactory == null)
            {
                throw new SerializationException(&quot;Could not find PortableFactory for factory-id: &quot; + factoryId);
            }
            var portable = portableFactory.Create(classId);
            if (portable == null)
            {
                throw new SerializationException(&quot;Could not create Portable for class-id: &quot; + classId);
            }
            return portable;
        }

        private DefaultPortableReader CreateReader(ObjectDataInput input, int factoryId, int classId, int version,
            int portableVersion)
        {
            var effectiveVersion = version;
            if (version &lt; 0)
            {
                effectiveVersion = _context.GetVersion();
            }
            var cd = _context.LookupClassDefinition(factoryId, classId, effectiveVersion);
            if (cd == null)
            {
                var begin = input.Position;
                cd = _context.ReadClassDefinition(input, factoryId, classId, effectiveVersion);
                input.Position = begin;
            }
            DefaultPortableReader reader;
            if (portableVersion == effectiveVersion)
            {
                reader = new DefaultPortableReader(this, input, cd);
            }
            else
            {
                reader = new MorphingPortableReader(this, input, cd);
            }
            return reader;
        }

        private int FindPortableVersion(int factoryId, int classId, IPortable portable)
        {
            var currentVersion = _context.GetClassVersion(factoryId, classId);
            if (currentVersion &lt; 0)
            {
                currentVersion = PortableVersionHelper.GetVersion(portable, _context.GetVersion());
                if (currentVersion &gt; 0)
                {
                    _context.SetClassVersion(factoryId, classId, currentVersion);
                }
            }
            return currentVersion;
        }

        /// &lt;exception cref=&quot;System.IO.IOException&quot;/&gt;
        internal IPortable Read(ObjectDataInput @in, int factoryId, int classId)
        {
            var version = @in.ReadInt();
            var portable = CreateNewPortableInstance(factoryId, classId);
            var portableVersion = FindPortableVersion(factoryId, classId, portable);
            var reader = CreateReader(@in, factoryId, classId, version, portableVersion);
            portable.ReadPortable(reader);
            reader.End();
            return portable;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,114,0],[26,9,27,80,0],[29,13,29,32,0],[30,13,30,80,0],[30,80,30,85,0],[30,85,30,92,0],[30,92,30,99,0],[30,99,30,101,0],[31,9,31,10,0],[33,30,33,73,0],[38,13,38,47,0],[40,17,40,109,0],[42,13,42,32,0],[44,17,44,82,0],[46,13,46,42,0],[47,13,47,40,0],[48,13,48,57,0],[49,9,49,10,0],[54,13,54,45,0],[56,17,56,107,0],[58,13,58,45,0],[59,13,59,43,0],[60,13,60,70,0],[65,13,65,32,0],[66,9,66,10,0],[70,13,70,45,0],[71,13,71,43,0],[72,13,72,43,0],[74,13,74,74,0],[75,13,75,85,0],[77,13,77,86,0],[83,13,83,45,0],[84,13,84,43,0],[85,13,85,43,0],[86,13,86,78,0],[92,13,92,66,0],[93,13,93,41,0],[94,13,94,70,0],[95,13,95,37,0],[96,13,96,26,0],[97,9,97,10,0],[101,13,101,72,0],[102,13,102,41,0],[104,17,104,113,0],[106,13,106,60,0],[107,13,107,34,0],[109,17,109,104,0],[111,13,111,29,0],[117,13,117,44,0],[118,13,118,29,0],[120,17,120,58,0],[122,13,122,91,0],[123,13,123,28,0],[125,17,125,44,0],[126,17,126,96,0],[127,17,127,40,0],[130,13,130,53,0],[132,17,132,69,0],[136,17,136,70,0],[138,13,138,27,0],[143,13,143,79,0],[144,13,144,36,0],[146,17,146,100,0],[147,17,147,40,0],[149,21,149,82,0],[152,13,152,35,0],[158,13,158,41,0],[159,13,159,74,0],[160,13,160,85,0],[161,13,161,90,0],[162,13,162,43,0],[163,13,163,26,0],[164,13,164,29,0]]);
    </script>
  </body>
</html>