<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\a\hazelcast-csharp-client\hazelcast-csharp-client\src\Hazelcast.Net\Security\KerberosCredentialsFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) 2008-2021, Hazelcast, Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

using System;
using System.Collections.Generic;
using Hazelcast.Core;
using Hazelcast.Exceptions;

namespace Hazelcast.Security
{
    /// &lt;summary&gt;
    /// Implements a Kerberos &lt;see cref=&quot;ICredentialsFactory&quot;/&gt;.
    /// &lt;/summary&gt;
    internal sealed class KerberosCredentialsFactory : IResettableCredentialsFactory
    {
        private static IKerberosTokenProvider _tokenProvider;
        private readonly string _spn;
        private ICredentials _credentials;

// disable &#39;can be removed as value is never read&#39; message
#pragma warning disable IDE0052
        private readonly string _username;
        private readonly string _password;
        private readonly string _domain;
#pragma warning restore IDE0052

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;KerberosCredentialsFactory&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The application will authenticate to the KDC as the current Windows user.&lt;/returns&gt;
        /// &lt;param name=&quot;spn&quot;&gt;The service principal name.&lt;/param&gt;
        public KerberosCredentialsFactory(string spn)
        {
            if (string.IsNullOrWhiteSpace(spn))
                throw new ArgumentException(&quot;Value cannot be null nor empty.&quot;, nameof(spn));
            _spn = spn;
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;KerberosCredentialsFactory&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The application will authenticate to the KDC as the specified domain user.&lt;/returns&gt;
        /// &lt;param name=&quot;spn&quot;&gt;The service principal name.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;A username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;A password.&lt;/param&gt;
        /// &lt;param name=&quot;domain&quot;&gt;A domain.&lt;/param&gt;
        public KerberosCredentialsFactory(string spn, string username, string password, string domain)
            : this(spn)
        {
            if (string.IsNullOrWhiteSpace(username))
                throw new ArgumentException(&quot;Value cannot be null nor empty.&quot;, nameof(username));
            _username = username;

            if (string.IsNullOrWhiteSpace(password))
                throw new ArgumentException(&quot;Value cannot be null nor empty.&quot;, nameof(password));
            _password = password;

            if (string.IsNullOrWhiteSpace(domain))
                throw new ArgumentException(&quot;Value cannot be null nor empty.&quot;, nameof(domain));
            _domain = domain;
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;KerberosCredentialsFactory&quot;/&gt;.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;args&quot;&gt;Arguments.&lt;/param&gt;
        public KerberosCredentialsFactory(IReadOnlyDictionary&lt;string, string&gt; args)
            : this(args.GetStringValue(&quot;spn&quot;))
        { }

        private static IKerberosTokenProvider TokenProvider
        {
            get
            {
                if (_tokenProvider != null) return _tokenProvider;

                // locate the token provider - so far we only support our Win32 provider

                var type = Type.GetType(&quot;Hazelcast.Security.KerberosTokenProvider, Hazelcast.Net.Win32&quot;);
                if (type == null) throw new HazelcastException(&quot;Failed to load a Kerberos token provider.&quot; +
                                                               &quot; Have you installed the Hazelcast.Net.Win32 NuGet package?&quot;);
                _tokenProvider = Activator.CreateInstance(type) as IKerberosTokenProvider;
                if (_tokenProvider == null) throw new HazelcastException(&quot;Failed to create a Kerberos token provider.&quot;);

                return _tokenProvider;
            }
        }

        /// &lt;inheritdoc /&gt;
        public ICredentials NewCredentials()
        {
            if (_credentials != null)
                return _credentials;

            var token = TokenProvider.GetToken(_spn, _username, _password, _domain);
            return new TokenCredentials(token);
        }

        /// &lt;inheritdoc /&gt;
        public void Reset()
        {
            _credentials = null;
        }

        /// &lt;inheritdoc /&gt;
        public void Dispose()
        { }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[43,9,43,54,0],[45,13,45,48,0],[46,17,46,93,0],[47,13,47,24,0],[48,9,48,10,0],[59,15,59,24,0],[61,13,61,53,0],[62,17,62,98,0],[63,13,63,34,0],[65,13,65,53,0],[66,17,66,98,0],[67,13,67,34,0],[69,13,69,51,0],[70,17,70,96,0],[71,13,71,30,0],[72,9,72,10,0],[79,15,79,47,0],[80,11,80,12,0],[86,17,86,44,0],[86,45,86,67,0],[90,17,90,106,0],[91,17,91,34,0],[91,35,92,126,0],[93,17,93,91,0],[94,17,94,44,0],[94,45,94,121,0],[96,17,96,39,0],[103,13,103,38,0],[104,17,104,37,0],[106,13,106,85,0],[107,13,107,48,0],[113,13,113,33,0],[114,9,114,10,0],[118,11,118,12,0]]);
    </script>
  </body>
</html>